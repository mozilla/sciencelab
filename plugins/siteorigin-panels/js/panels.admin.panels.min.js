(function($){var newPanelId=0;panels.undoManager=new UndoManager();$.fn.getPanelData=function(){var $$=$(this);var data={};$$.data('dialog').find('*[name]').not('[data-info-field]').each(function(){var name=/widgets\[[0-9]+\]\[([^\]]+)\]/.exec($(this).attr('name'));name=name[1];data[name]=$(this).val();});return data;}
$.fn.panelsCreatePanel=function(type,data){newPanelId++;var dialogWrapper=$(this);var $$=dialogWrapper.find('.panel-type').filter(function(){return $(this).data('class')===type});if($$.length==0)return null;$('#panels-undo-message').fadeOut(function(){$(this).remove()});var panel=$('<div class="panel new-panel"><div class="panel-wrapper"><div class="title"><h4></h4><span class="actions"></span></div><small class="description"></small></div></div>').attr('data-type',type);var dialog;var formHtml=$$.attr('data-form');formHtml=formHtml.replace(/\{\$id\}/g,newPanelId);panel.data({'title-field':$$.attr('data-title-field'),'title':$$.attr('data-title')}).find('h4, h5').click(function(){dialog.dialog('open');return false;}).end().find('.description').html($$.find('.description').html());var dialogButtons={};var deleteFunction=function(){panels.undoManager.register(this,function(type,data,container,position){var panel=$('#panels-dialog').panelsCreatePanel(type,data,container);panels.addPanel(panel,container,position,true);$('#panels-container .panel').removeClass('new-panel');},[panel.attr('data-type'),panel.getPanelData(),panel.closest('.panels-container'),panel.index()],'Remove Panel');$('#panels-undo-message').remove();$('<div id="panels-undo-message" class="updated"><p>'+panels.i10n.messages.deleteWidget+' - <a href="#" class="undo">'+panels.i10n.buttons.undo+'</a></p></div>').appendTo('body').hide().slideDown().find('a.undo').click(function(){panels.undoManager.undo();$('#panels-undo-message').fadeOut(function(){$(this).remove()});return false;});var remove=function(){panel.data('dialog').dialog('destroy').remove();panel.remove();$('#panels-container .panels-container').trigger('refreshcells');};if(panels.animations)panel.slideUp(remove);else{panel.hide();remove();}
dialog.dialog('close');};dialogButtons[panels.i10n.buttons['done']]=function(){$(this).trigger('panelsdone',panel,dialog);panel.panelsSetPanelTitle();dialog.dialog('close');}
dialog=$('<div class="panel-dialog dialog-form"></div>').addClass('widget-dialog-'+type.toLowerCase()).html(formHtml).dialog({dialogClass:'panels-admin-dialog',autoOpen:false,modal:false,draggable:false,resizable:false,title:panels.i10n.messages.editWidget.replace('%s',$$.attr('data-title')),minWidth:760,maxHeight:Math.round($(window).height()*0.925),create:function(event,ui){$(this).closest('.ui-dialog').find('.show-in-panels').show();},open:function(){$(this).trigger('panelsopen',panel,dialog);$(this).closest('.ui-dialog').find('a').blur();var overlay=$('<div class="ui-widget-overlay ui-front"></div>').css('z-index',1000);$(this).data('overlay',overlay).closest('.ui-dialog').before(overlay);},close:function(){$(this).data('overlay').remove();},buttons:dialogButtons}).keypress(function(e){if(e.keyCode==$.ui.keyCode.ENTER){if($(this).closest('.ui-dialog').find('textarea:focus').length>0)return;$(this).closest('.ui-dialog').find('.ui-dialog-buttonpane .ui-button:eq(0)').click();e.preventDefault();return false;}
else if(e.keyCode===$.ui.keyCode.ESCAPE){$(this).closest('.ui-dialog').dialog('close');}});panel.data('dialog',dialog).disableSelection();panel.find('.title .actions').append($('<a>'+panels.i10n.buttons.edit+'<a>').addClass('edit').click(function(){dialog.dialog('open');return false;})).append($('<a>'+panels.i10n.buttons.duplicate+'<a>').addClass('duplicate').click(function(){var duplicatePanel=$('#panels-dialog').panelsCreatePanel(panel.attr('data-type'),panel.getPanelData());window.panels.addPanel(duplicatePanel,panel.closest('.panels-container'),null,false);duplicatePanel.removeClass('new-panel');return false;})).append($('<a>'+panels.i10n.buttons.delete+'<a>').addClass('delete').click(function(){deleteFunction();return false;}));if(data!=undefined){for(c in data){if(c!='info'){var de=dialog.find('*[name$="['+c+']"]');if(de.attr('type')=='checkbox'){de.prop('checked',Boolean(data[c]));}
else{de.val(data[c]);}}}}
panel.panelsSetPanelTitle();$(window).resize();$(document).trigger('panelssetup',panel,dialog);return panel;}
panels.addPanel=function(panel,container,position,animate){if(container==null)container=$('#panels-container .cell.cell-selected .panels-container').eq(0);if(container.length==0)container=$('#panels-container .cell .panels-container').eq(0);if(container.length==0)return;if(position==null)container.append(panel);else{var current=container.find('.panel').eq(position);if(current.length==0)container.append(panel);else{panel.insertBefore(current);}}
container.sortable("refresh").trigger('refreshcells');container.closest('.grid-container').panelsResizeCells();if(animate){if(panels.animations)
$('#panels-container .panel.new-panel').hide().slideDown(500,function(){panel.data('dialog').dialog('open')}).removeClass('new-panel');else{$('#panels-container .panel.new-panel').show().removeClass('new-panel');setTimeout(function(){panel.data('dialog').dialog('open');},500);}}}
$.fn.panelsSetPanelTitle=function(){return $(this).each(function(){var titleValue='';$(this).data('dialog').find('input[type="text"], textarea').each(function(){titleValue=$(this).val();if(titleValue!='')return false;});$(this).find('h4').html($(this).data('title')+'<span>'+titleValue.substring(0,80).replace(/(<([^>]+)>)/ig,"")+'</span>');});}
panels.loadPanels=function(data){panels.clearGrids();for(var gi in data.grids){var cellWeights=[];for(var ci in data.grid_cells){if(Number(data.grid_cells[ci]['grid'])==gi){cellWeights[cellWeights.length]=Number(data.grid_cells[ci].weight);}}
var grid=panels.createGrid(Number(data.grids[gi]['cells']),cellWeights,data.grids[gi]['style']);for(var pi in data.widgets){if(Number(data.widgets[pi]['info']['grid'])==gi){var pd=data.widgets[pi];var panel=$('#panels-dialog').panelsCreatePanel(pd['info']['class'],pd);grid.find('.panels-container').eq(Number(data.widgets[pi]['info']['cell'])).append(panel)}}}
$('#panels-container .panels-container').sortable('refresh').trigger('refreshcells');$('#panels-container .panel').removeClass('new-panel');$('#panels-container .grid-container').each(function(){$(this).panelsResizeCells();});}})(jQuery);